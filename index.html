<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flags Letter Animation</title>
    <style>
        body {
            margin: 0;
            background-color: #e0ddd7;
            overflow: hidden; /* No scrolling for this focused demo */
            height: 100vh;
        }
    body::before {
        content: "";
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAPklEQVR42mP4//8/w6CgIK8gA05OSEgA4kOTk5P/g/JyMhA4/g9xcXF/4Ovr6+s/g5qaminp6en/g5wB5GysAgDE1w2t3/p/dAAAAABJRU5ErkJggg==');
        background-repeat: repeat;  /* Explicitly tile the pattern */
        opacity: 0.3;  /* Increase for testing; reduce back to 0.1 once working */
        pointer-events: none;
        z-index: 1;  /* Place it above body's background but below content */
        mix-blend-mode: multiply;  /* Optional: Enhances grain texture (try 'overlay' or remove) */
    }
        #container {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
        }
        #envelope {
            position: fixed;
            width: 300px;
            height: 200px;
            background-color: #f5f5f5;
            border: 2px solid #333;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 20;
            visibility: hidden; /* Hidden until animation */
        }
        #dear-neighbor {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: serif;
            font-size: 48px;
            color: #333;
            text-align: center;
            z-index: 15;
        }
        .glyph {
            position: fixed;
            color: #333;
            padding: 2px;
            border-radius: 3px;
            visibility: hidden;
            z-index: 10;
            pointer-events: none;
        }
        .glyph.blurred {
            filter: blur(1px);
        }
        #text-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            color: #333;
            font-family: serif;
            font-size: 16px;
            visibility: hidden; /* Hide for layout calculation */
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="envelope"></div>
    <div id="dear-neighbor">Dear Neighbor,</div>
    <div id="text-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        console.log("Animation script started.");

        const container = document.getElementById('container');
        const envelope = document.getElementById('envelope');
        const textContainer = document.getElementById('text-container');
        const text = "We are Flags, a map-based social network starting in Berlin, Germany. Using AI, we extract house features to create stylized, recognizable EU cities. Join us to connect with your neighbors, explore local events, and build a vibrant community. Let's make our city a place we're proud to call home.";

        // Position envelope initially off-screen
        gsap.set(envelope, { x: window.innerWidth / 2 - 150, y: -window.innerHeight, visibility: 'visible' });

        function layoutText() {
            console.log("Calculating final text layout...");
            let html = '';
            text.split('').forEach(char => {
                html += `<span>${char}</span>`;
            });
            textContainer.innerHTML = html;

            const finalPositions = [];
            const spans = textContainer.querySelectorAll('span');
            const offsetTopAdjustment = 100; // Space below "Dear Neighbor,"
            spans.forEach(span => {
                finalPositions.push({ 
                    x: span.offsetLeft + textContainer.offsetLeft,
                    y: span.offsetTop + textContainer.offsetTop + offsetTopAdjustment
                });
            });

            textContainer.innerHTML = ''; // Clear after measuring
            return finalPositions;
        }

        const finalPositions = layoutText();
        console.log("Final text positions calculated. Count:", finalPositions.length);

        // --- Matter.js Setup ---
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies;

        const engine = Engine.create();
        const world = engine.world;
        world.gravity.y = 2.0; // Stronger gravity for faster falling

        // Add a floor to pile glyphs at the bottom
        const floor = Bodies.rectangle(
            window.innerWidth / 2,
            window.innerHeight + 20, // Just below viewport
            window.innerWidth,
            50,
            { isStatic: true }
        );
        World.add(world, floor);

        const glyphs = [];
        const glyphBodies = [];

        text.split('').forEach((char, i) => {
            const glyph = document.createElement('div');
            glyph.className = 'glyph';
            glyph.innerText = char;
            glyph.setAttribute('aria-label', char); // Basic accessibility
            container.appendChild(glyph);
            glyphs.push(glyph);

            if (Math.random() > 0.97) glyph.classList.add('blurred'); // Less frequent blur
            gsap.set(glyph, { visibility: 'visible', fontSize: gsap.utils.random(12, 28) });

            const body = Bodies.rectangle(
                window.innerWidth / 2, // Start inside envelope center
                window.innerHeight / 2,
                glyph.offsetWidth,
                glyph.offsetHeight,
                { frictionAir: 0.01, restitution: 0.3 } // Low friction for floating feel
            );
            glyphBodies.push({ element: glyph, body: body });
            World.add(world, body);
        });
        console.log("Glyphs created. Count:", glyphs.length);

        // --- Physics Ticker ---
        const tickerCallback = () => {
            Engine.update(engine);
            glyphBodies.forEach(({ element, body }) => {
                gsap.set(element, {
                    x: body.position.x,
                    y: body.position.y,
                    rotation: body.angle * (180 / Math.PI)
                });
            });
        };

        // --- Animation Sequence ---
        // Phase 1: Envelope slides in from top
        gsap.to(envelope, {
            y: window.innerHeight / 2 - 100,
            duration: 1,
            ease: 'power2.out',
            onComplete: () => {
                console.log("Envelope arrived. Opening...");
                // Phase 2: Open envelope, glyphs jump out
                gsap.to(envelope, {
                    scale: 1.1,
                    opacity: 0.5,
                    duration: 0.5,
                    ease: 'power1.in',
                    onComplete: () => gsap.set(envelope, { visibility: 'hidden' }) // Hide after opening
                });

                // Start physics and make glyphs jump out
                gsap.ticker.add(tickerCallback);
                console.log("Physics ticker started. Glyphs jumping out.");
                glyphBodies.forEach(({ body }) => {
                    Matter.Body.applyForce(body, body.position, {
                        x: gsap.utils.random(-0.1, 0.1),
                        y: gsap.utils.random(-0.4, -0.2) // Upward jump for "jumping out"
                    });
                });

                setTimeout(() => {
                    console.log("Phase 3: Spreading and laying at bottom.");
                    world.gravity.y = 0; // Stop vertical gravity briefly for floating
                    glyphBodies.forEach(({ body }) => {
                        body.frictionAir = 0.05; // Increase friction to slow down
                        Matter.Body.applyForce(body, body.position, {
                            x: gsap.utils.random(-0.02, 0.02),
                            y: 0.05 // Gentle push down to settle
                        });
                    });
                    world.gravity.y = 2.0; // Re-enable to pile at bottom
                }, 2000);
            }
        });

        setTimeout(() => {
            console.log("Phase 4: Handoff to GSAP for text assembly.");
            gsap.ticker.remove(tickerCallback);
            console.log("Physics ticker stopped.");

            const assemblyTl = gsap.timeline();
            glyphs.forEach((glyph, i) => {
                if (finalPositions[i]) {
                    assemblyTl.to(glyph, {
                        x: finalPositions[i].x,
                        y: finalPositions[i].y,
                        rotation: 0,
                        fontSize: '16px',
                        filter: 'none',
                        duration: 1.5,
                        ease: 'power3.inOut'
                    }, 0);
                }
            });
            console.log("GSAP assembly timeline created and playing.");
        }, 4500);

    </script>
</body>
</html>
